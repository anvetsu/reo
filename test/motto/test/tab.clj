(ns motto.test.tab
  (:use [clojure.test]
        [motto.test.util]))

(deft basic-test
  ["a:tab(['a 'b 'c] [10 20 30])" 'a
   "a('a)" 10
   "a:tab(['a 'b 'c] [[10 20 30] [100 200 300] [40 50 60 70]])" 'a
   "a('b)(2)" 300
   "a:tab([dict('a 10 'b 20 'c 30) dict('a 100 'b 200 'c 300)])" 'a
   "a('a)(1)" 100
   "tab([6 2] [4210 3121 4807 4284 3609 7543 5712 2601 2305 3364 4568 2784])"
   [[4210 3121][4807 4284][3609 7543][5712 2601][2305 3364][4568 2784]]
   "tab([3 3] [12 56 78 74 85 96 30 22 44 66 82 27])"
   [[12 56 78][74 85 96][30 22 44]]
   "tab([3 4] inf(0))"
   [[0 0 0 0][0 0 0 0][0 0 0 0]]
   "tab([3 9] [12 56 78 74 85 96 30 22 44 66 82 27])"
   [[12 56 78 74 85 96 30 22 44][66 82 27 12 56 78 74 85 96][30 22 44 66 82 27 12 56 78]]
   "xs:tab([30] [1 5 0 0])" 'xs
   "xs" [1 5 0 0 1 5 0 0 1 5 0 0 1 5 0 0 1 5 0 0 1 5 0 0 1 5 0 0 1 5]
   "dim(xs)" [30]
   "xs:tab([3 4] [2 4 6 8])" 'xs
   "xs" [[2 4 6 8]
         [2 4 6 8]
         [2 4 6 8]]
   "dim(xs)" [3 4]
   "tab([5 5] [1 0 0 0 0 0])" [[1 0 0 0 0]
                               [0 1 0 0 0]
                               [0 0 1 0 0]
                               [0 0 0 1 0]
                               [0 0 0 0 1]]
   "xs:tab([5 2 12] [26 16 22 17 21 44 25 22 23 44 41 33 43 36 47 49 30 22 57 20 45 60 43 22 44 21 58 57 17 43 47 17 43 26 53 23 29 19 23 38 53 47 38 22 40 57 35 26 37 27 53 26 29 46 25 26 30 20 32 16 56 55 25 47 38 27 39 59 20 28 42 25 21 57 55 44 16 54 26 16 55 56 45 45 16 55 26 20 27 55 36 39 43 38 50 16 27 23 56 41 53 60 39 47 44 47 17 28 24 35 61 26 22 35 24 20 31 35 47 37])" 'xs
   "xs" [[[26 16 22 17 21 44 25 22 23 44 41 33]
          [43 36 47 49 30 22 57 20 45 60 43 22]]
         [[44 21 58 57 17 43 47 17 43 26 53 23]
          [29 19 23 38 53 47 38 22 40 57 35 26]]
         [[37 27 53 26 29 46 25 26 30 20 32 16]
          [56 55 25 47 38 27 39 59 20 28 42 25]]
         [[21 57 55 44 16 54 26 16 55 56 45 45]
          [16 55 26 20 27 55 36 39 43 38 50 16]]
         [[27 23 56 41 53 60 39 47 44 47 17 28]
          [24 35 61 26 22 35 24 20 31 35 47 37]]]
   "dim(xs)" [5 2 12]
   "dig(xs [[3 4] [1] range(0 6)])" [[[16 55 26 20 27 55]][[24 35 61 26 22 35]]]])

(deft club-test
  ["a:tab(['a 'b] [[10 20] [30 40]])" 'a
   "b:tab(['a 'c] [[100 200] [300 400]])" 'b
   "c:club(a, b)" 'c
   "fields(c)" ['a 'b 'c]
   "c('a)" [100 200]
   "c('c)" [300 400]
   "c('b)" [30 40]
   "c:club(b a)" 'c
   "fields(c)" ['a 'c 'b]
   "c('a)" [10 20]
   "c('c)" [300 400]
   "c('b)" [30 40]])

(deft csv-test
  ["emp:csv(\"test/data/emp.csv\")" 'emp
   "count(fields(emp))" 4
   "emp('Name)(0)" "Tom. G"
   "sum(map(parse, emp('Salary)))" 12623.76
   "emp('DOJ)(1)" "2014-03-15T10:10:45Z"
   "cfg:dict('types ['s 'i 'd])" 'cfg
   "emp:csv(\"test/data/emp.csv\" cfg)" 'emp
   "emp('Dept)(1)" 2
   "sum(emp('Salary))" 12623.76
   "emp('DOJ)(1)" "2014-03-15T10:10:45Z"
   "((fn(e) e('Dept)>1)!emp)('Name)(0)" "Ken M"
   "trimtm:fn(s) dt(first(ssplit(s \"T\")) \"yyyy-MM-dd\")" 'trimtm
   "cfg:dict('types ['s 'i 'd trimtm])" 'cfg
   "emp:csv(\"test/data/emp.csv\" cfg)" 'emp
   "sdt(emp('DOJ)(1))" "2014-03-15T00:00:00"
   "cfg:dict('headers ['n 'd 's], 'delim \\:)" 'cfg
   "emp:csv(\"test/data/emp2.csv\", cfg)" 'emp
   "fields(emp)" ['n 'd 's]
   "emp('d)(2)" "3"])

(deft tabopr-test
  ["[2 4]$[5 6 7 8 9]" [[5 6 7 8][9 5 6 7]]
   "[2 2]$[1]" [[1 1] [1 1]]
   "3$1" [1 1 1]
   "table:[2 3]$[5 6 7 8 9 10]" 'table
   "table" [[5 6 7][8 9 10]]
   "10 * table" [[50 60 70][80 90 100]]
   "table + table" [[10 12 14][16 18 20]]
   "[0 1] * table" [[0 0 0][8 9 10]]
   "[0 1] * table+table" [[5 6 7][16 18 20]]
   "[0 1] * (table+table)" [[0 0 0][16 18 20]]])

(deft rt-test
  ["cd:['name 'age]$[[\"sam\" \"marie\" \"joe\"] [3 4 2]]" 'cd
   "t:flip(cd)" 't
   "data(t)(0)" ["sam" 3]
   "data(t)(1)(1)" 4
   "cd2:flip(t)" 'cd2
   "fields(cd2)" ['name 'age]
   "cd2('age)" [3 4 2]
   "cd2('name)" ["sam" "marie" "joe"]])

(deft sel-grp-test
  ["t:['c1 'c2 'c3]$[1000+til(6) ['a 'b 'c 'a 'b 'a] 10*(1+til(6))]" 't
   "[c1 v]:[t('c1) 2*t('c3)]" 'v
   "[c1 v]" [[1000 1001 1002 1003 1004 1005][20 40 60 80 100 120]]
   "[x y]:[group(`+` 0 t('c3) t('c2)) group(^inc(X2) 0 c1 t('c2))]" 'y
   "t2:tab([x y])" 't2
   "fields(t2)" ['a 'b 'c]
   "[t2('a) t2('b) t2('c)]" [[110 3][70 2][30 1]]
   "t2:tmap(^if {X1('c2)='a ['c3:10*X1('c3)] X1} t)" 't2
   "t2('c3)" [100 20 30 400 50 600]
   "rt:rtab(fields(t) sort(^X1(1) < X2(1), data(flip(t))))" 'rt
   "flip(rt)('c2)" ['a 'a 'a 'b 'b 'c]])

(deft flip-raw-test
  ["xs:[5 4]$til(20) xs" [[0 1 2 3][4 5 6 7][8 9 10 11][12 13 14 15][16 17 18 19]]
   "flip(xs)" [[0 4 8 12 16][1 5 9 13 17][2 6 10 14 18][3 7 11 15 19]]
   "flip(flip(xs))" [[0 1 2 3][4 5 6 7][8 9 10 11][12 13 14 15][16 17 18 19]]])
